---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { Icon } from 'astro-icon/components';
import { getRelatedBlogPosts } from '../../utils/internalLinks';
import BlogLeadPopup from '../../components/BlogLeadPopup.astro';

// Generate static paths for all blog posts
export async function getStaticPaths() {
  const blogEntries = await getCollection('blog');
  return blogEntries.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

// Get the blog post for the current page
const { entry } = Astro.props;
const { Content, headings } = await entry.render();

// Calculate read time
const wordCount = entry.body.split(/\s+/g).length;
const readTime = Math.ceil(wordCount / 200);

// Get related posts
const allPosts = await getCollection('blog');
const relatedPosts = getRelatedBlogPosts(
  entry.data.tags || [], 
  allPosts.filter(p => p.slug !== entry.slug), 
  3
);

// Generate JSON-LD structured data for the article
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": entry.data.title,
  "datePublished": entry.data.pubDate.toISOString(),
  "author": {
    "@type": "Person",
    "name": entry.data.author
  },
  "publisher": {
    "@type": "Organization",
    "name": "MD Homecare",
    "logo": {
      "@type": "ImageObject",
      "url": new URL('/src/assets/logo.svg', Astro.url).toString()
    }
  },
  "description": entry.data.description,
  "image": entry.data.image,
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": Astro.url.href
  }
};

const structuredData = JSON.stringify(articleSchema);
const canonicalUrl = new URL(`/blog/${entry.slug}`, Astro.site).toString();
---

<BaseLayout
  title={entry.data.title}
  description={entry.data.description}
  image={entry.data.image}
  canonical={canonicalUrl}
>
  <script type="application/ld+json" set:html={structuredData} />

  <div class="w-full">
    <article>
       <!-- Hero Section -->
       <header class="relative min-h-[60vh] flex items-center justify-center overflow-hidden pt-20">
          <!-- Background Image with Overlay -->
          <div class="absolute inset-0 bg-cover bg-center bg-no-repeat bg-fixed top-0" style={entry.data.image ? `background-image: url('${entry.data.image}')` : 'background-color: oklch(var(--b2))'}></div>
          <div class="absolute inset-0 bg-gradient-to-b from-black/50 via-black/20 to-base-100 top-0"></div>

          <!-- Glass Console Frame -->
          <div class="container-custom relative z-10 px-4 py-12">
             <div class="max-w-4xl mx-auto bg-white/80 backdrop-blur-xl rounded-[2.5rem] border border-white/50 shadow-2xl p-8 md:p-10 text-center">
                
                <!-- Title -->
                <h1 class="text-3xl md:text-5xl font-bold text-secondary mb-6 leading-[1.1] tracking-tight text-balance">
                  {entry.data.title}
                </h1>

                <!-- Description/Excerpt -->
                 <p class="text-lg md:text-xl text-secondary/70 font-medium mb-8 leading-relaxed max-w-2xl mx-auto text-balance">
                   {entry.data.description}
                 </p>

                <!-- Author & Metadata -->
                <div class="flex flex-col md:flex-row items-center justify-center gap-6 md:gap-12 pt-8 border-t border-base-200/50">
                   
                   <!-- Author -->
                   <div class="flex items-center gap-4 text-left">
                      <div class="avatar">
                         <div class="w-12 h-12 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                           <img src="/assets/avatar.webp" alt={entry.data.author} />
                         </div>
                      </div>
                      <div>
                         <p class="font-bold text-secondary text-base leading-none mb-1">{entry.data.author}</p>
                         <p class="text-secondary/60 text-xs uppercase tracking-wider font-bold">Healthcare Expert</p>
                      </div>
                   </div>

                   <!-- Divider (Hidden on mobile) -->
                   <div class="hidden md:block w-px h-10 bg-base-300"></div>

                   <!-- Metadata -->
                   <div class="flex flex-wrap justify-center gap-4 text-sm font-medium text-secondary/70">
                       <span class="flex items-center gap-2">
                          <Icon name="hugeicons:calendar-01" class="h-4 w-4 text-primary" />
                          {entry.data.pubDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                       </span>
                       <span class="flex items-center gap-2">
                          <Icon name="hugeicons:time-01" class="h-4 w-4 text-primary" />
                          {readTime} min read
                       </span>
                        {entry.data.tags && entry.data.tags.length > 0 && (
                         <span class="flex items-center gap-2 text-primary font-bold">
                            <Icon name="hugeicons:tag-01" class="h-4 w-4" />
                            {entry.data.tags[0]}
                         </span>
                       )}
                   </div>

                </div>

             </div>
          </div>
       </header>

       <!-- Main Content -->
       <div class="max-w-3xl mx-auto px-4 py-20">
          
          <!-- Table of Contents (Inline) -->
          {headings && headings.length > 0 && (
            <div class="bg-base-100 rounded-[2rem] p-8 mb-12 border-2 border-base-200 shadow-sm">
               <h2 class="text-xl font-bold text-secondary mb-6 flex items-center gap-2">
                 <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                    <Icon name="hugeicons:menu-01" class="h-5 w-5" />
                 </div>
                 In this article
               </h2>
               <ul class="space-y-3">
                 {headings.filter(h => h.depth <= 2).map(h => (
                   <li>
                     <a href={`#${h.slug}`} class="text-secondary/70 hover:text-primary hover:translate-x-1 transition-all duration-300 font-medium flex items-start gap-3 group">
                       <span class="w-1.5 h-1.5 rounded-full bg-primary/40 mt-2 group-hover:bg-primary transition-colors"></span>
                       {h.text}
                     </a>
                   </li>
                 ))}
               </ul>
            </div>
          )}

          <div class="prose prose-lg max-w-none prose-headings:font-bold prose-h2:text-3xl prose-h2:text-secondary prose-p:text-secondary/70 prose-li:text-secondary/70 post-content">
             <Content />
          </div>

          <!-- CTA Banner -->
          <div class="bg-primary text-primary-content my-16 shadow-2xl shadow-primary/20 rounded-[2.5rem] p-8 md:p-12 relative overflow-hidden">
              <div class="absolute top-0 right-0 -translate-y-1/2 translate-x-1/3 w-64 h-64 bg-white/10 rounded-full blur-3xl pointer-events-none"></div>
              <div class="absolute bottom-0 left-0 translate-y-1/2 -translate-x-1/3 w-64 h-64 bg-white/10 rounded-full blur-3xl pointer-events-none"></div>
              
              <div class="flex flex-col md:flex-row items-center justify-between w-full gap-8 relative z-10">
                <div class="text-center md:text-left">
                  <h3 class="font-bold text-2xl md:text-3xl mb-2">Need support at home?</h3>
                  <p class="text-primary-content/90 text-lg">Our compassionate team is ready to help you or your loved ones.</p>
                </div>
                <a href="/contact#contact-form" class="btn btn-lg bg-white text-primary border-none hover:bg-base-100 rounded-full px-8 shadow-lg shrink-0">
                  Contact Us Today
                </a>
              </div>
          </div>
          
           <!-- Back to Blog -->
          <div class="flex justify-center mt-12">
            <a href="/blog" class="btn btn-ghost gap-2 rounded-full hover:bg-base-200 text-secondary/70 hover:text-primary transition-colors">
                <Icon name="hugeicons:arrow-left-01" class="h-5 w-5" />
                Back to Blog
            </a>
          </div>

       </div>

       <!-- Related Posts -->
       {relatedPosts.length > 0 && (
        <section class="bg-base-200 py-24 px-4 border-t border-base-200">
          <div class="max-w-6xl mx-auto">
            <h2 class="text-3xl font-bold text-center text-secondary mb-16">Related Articles</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
              {relatedPosts.map((post) => (
                <a href={`/blog/${post.slug}`} class="card bg-white rounded-[2.5rem] shadow-lg shadow-base-200/50 border border-base-200 hover:border-primary/50 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 group overflow-hidden">
                  <div class="h-48 overflow-hidden relative">
                    <img src={post.data.image || '/assets/homecare.webp'} alt={post.data.title} class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" />
                    <div class="absolute inset-0 bg-black/10 group-hover:bg-transparent transition-colors"></div>
                  </div>
                  <div class="card-body p-8">
                    <div class="flex gap-2 mb-3">
                         {post.data.tags && post.data.tags.length > 0 && (
                            <span class="text-xs font-bold text-primary bg-primary/10 px-3 py-1 rounded-full uppercase tracking-wide">
                                {post.data.tags[0]}
                            </span>
                         )}
                    </div>
                    <h3 class="card-title text-xl font-bold text-secondary mb-3 group-hover:text-primary transition-colors line-clamp-2">{post.data.title}</h3>
                    <p class="text-secondary/60 text-sm line-clamp-3 leading-relaxed mb-6">{post.data.description}</p>
                    <span class="text-primary font-bold text-sm inline-flex items-center gap-2 mt-auto">
                      Read Article
                      <Icon name="hugeicons:arrow-right-01" class="h-4 w-4 transition-transform group-hover:translate-x-1" />
                    </span>
                  </div>
                </a>
              ))}
            </div>
          </div>
        </section>
      )}

    </article>
  </div>

  <!-- Lead Capture Popup -->
  <BlogLeadPopup />
</BaseLayout>

<style>
  @reference "../../styles/global.css";
  
  /* iOS fix for background images */
  @supports (-webkit-touch-callout: none) {
    header {
      background-attachment: scroll !important;
    }
  }

  /* Prose styling enhancements */
  .prose h2 {
    @apply text-2xl md:text-3xl font-bold mt-16 mb-8 text-secondary relative;
  }
  
  /* Decorative line for H2 */
  .prose h2::after {
      content: '';
      @apply absolute bottom-[-1rem] left-0 w-20 h-1 bg-primary rounded-full;
  }

  .prose h3 {
    @apply text-xl font-bold mt-12 mb-4 text-secondary;
  }

  .prose h4 {
    @apply text-lg font-bold mt-8 mb-3 text-secondary;
  }

  .prose p {
    @apply mb-6 text-secondary/70 leading-relaxed text-lg;
  }

  .prose ul, .prose ol {
    @apply mb-8 pl-6 space-y-3;
  }

  .prose ul {
    @apply list-none;
  }
  
  .prose ul li {
      @apply relative pl-6 text-secondary/70 text-lg;
  }
  
  .prose ul li::before {
      content: '';
      @apply absolute left-0 top-[0.6em] w-2 h-2 rounded-full bg-primary;
  }

  .prose ol {
    @apply list-decimal marker:text-primary marker:font-bold;
  }

  .prose a {
    @apply text-primary font-bold no-underline hover:underline decoration-2 underline-offset-4 transition-all;
  }

  .prose blockquote {
    @apply border-l-4 border-primary pl-8 py-6 my-10 bg-base-200/50 rounded-r-3xl italic text-xl text-secondary font-medium shadow-sm relative overflow-hidden;
  }
  
  .prose blockquote::before {
      content: '"';
      @apply absolute top-0 left-2 text-6xl text-primary/10 font-serif leading-none;
  }

  .prose code {
    @apply bg-base-200 px-2 py-1 rounded-md text-sm font-mono text-primary;
  }

  .prose img {
    @apply rounded-[2.5rem] shadow-xl my-12 w-full border-4 border-white;
  }
  
  /* Stronger emphasis for bold text */
  .prose strong {
      @apply text-secondary font-bold;
  }

  .prose hr {
    @apply border-base-200 my-16;
  }
</style>

<script>
  // Service keywords to match and link
  // Same content as original script but cleaned up if needed
  interface ServiceKeyword {
    slug: string;
    keywords: string[];
  }

  const serviceKeywords: ServiceKeyword[] = [
    { slug: 'clinical-care', keywords: ['clinical care', 'nursing services', 'wound care', 'medication administration', 'catheter care', 'ostomy care', 'diabetic management', 'health assessments', 'vital signs monitoring', 'medical assessment', 'nursing care', 'high-intensity personal activities', 'medication management', 'monitoring of medical conditions', 'complex medical needs'] },
    { slug: 'personal-care', keywords: ['personal care', 'bathing assistance', 'grooming assistance', 'personal hygiene', 'showering assistance', 'dressing assistance', 'oral hygiene', 'toileting assistance', 'medication reminders', 'personal care services', 'continence management', 'personal support'] },
    { slug: 'domestic-assistance', keywords: ['domestic assistance', 'household tasks', 'home help', 'cleaning services', 'meal preparation', 'laundry services', 'gardening services', 'shopping assistance', 'household chores', 'domestic support', 'household maintenance', 'domestic help', 'daily household tasks'] },
    { slug: 'respite-care', keywords: ['respite care', 'respite services', 'carer relief', 'short-term care', 'in-home respite', 'short term accommodation', 'STA', 'respite costs', 'carer support', 'respite funding', 'short term respite'] },
    { slug: 'disability-services', keywords: ['disability support', 'disability services', 'NDIS support', 'daily living assistance', 'NDIS funding', 'disability assistance', 'person-centered approach', 'NDIS provider', 'NDIS business', 'people with disability', 'participant-focused', 'participant plans', 'intermediate care needs', 'NDIS participants', 'disability support services'] },
    { slug: 'support-workers', keywords: ['support workers', 'care workers', 'disability support workers', 'NDIS support worker', 'independent support worker', 'support staff', 'care staff', 'support worker rates', 'support worker pay', 'key personnel', 'staffing solutions', 'hiring compliant staff', 'aged care worker', 'care worker qualifications', 'qualified support workers'] },
    { slug: 'sil-services', keywords: ['supported independent living', 'SIL', 'supported accommodation', 'group homes', 'shared living support', 'disability accommodation', 'independent living support', 'supported living services', 'SIL services'] },
    { slug: 'disability-home-support-services', keywords: ['disability home support', 'home modifications', 'housing support', 'in-home support', 'home-based care', 'disability home care', 'home support services', 'assistive products', 'living independently', 'home care assistance'] },
    { slug: 'aged-care-home-modifications-maintenance', keywords: ['home modifications', 'aged care modifications', 'accessibility modifications', 'home maintenance', 'bathroom modifications', 'kitchen modifications', 'ramps installation', 'handrails installation', 'home modification services', 'premises fit-out', 'safety enhancements', 'accessibility improvements'] },
    { slug: 'therapy-services', keywords: ['therapy services', 'physiotherapy', 'occupational therapy', 'speech therapy', 'rehabilitation services', 'behavioral therapy', 'psychology services', 'exercise physiology', 'counselling services', 'dietetics', 'social work', 'therapeutic supports', 'specialized expertise', 'allied health services', 'podiatry services'] },
    { slug: 'transport-services', keywords: ['transport services', 'disability transport', 'assisted transport', 'medical transport', 'transportation assistance', 'NDIS transport funding', 'mobility support', 'transport funding', 'social and recreational activities', 'transport to appointments', 'transport to social events'] },
    { slug: 'specialist-disability-accommodation', keywords: ['specialist disability accommodation', 'SDA', 'disability housing', 'accessible housing', 'improved liveability', 'SDA funding', 'NDIS housing', 'accessible accommodation'] },
    { slug: 'community-access-support', keywords: ['community access', 'social participation', 'community inclusion', 'community activities', 'social support', 'social skills development', 'community engagement', 'recreational activities', 'community participation', 'community participation support', 'community networking', 'community services', 'community connections', 'staying active and connected'] },
    { slug: 'ndis-specialist-support-coordination', keywords: ['support coordination', 'NDIS coordination', 'disability coordination', 'NDIS planning', 'plan management', 'specialist support coordination', 'service coordination', 'support coordinators', 'local area coordinators', 'LACs', 'service agreements', 'care plan coordination', 'chosen provider'] },
    { slug: 'ndis-behaviour-support-practitioner-training', keywords: ['behavior support', 'behaviour support', 'positive behavior support', 'behavior management', 'behavior practitioner', 'behavioral strategies', 'behavioral intervention', 'behaviour support services', 'safeguarding practices', 'NDIS Practice Standards', 'NDIS Code of Conduct'] },
    { slug: 'home-care-packages', keywords: ['home care package', 'level 3 home care package', 'level 1 home care package', 'level 2 home care package', 'level 4 home care package', 'consumer-directed care', 'aged care assessment team', 'ACAT assessment', 'my aged care', 'commonwealth home support programme', 'support at home program', 'care needs assessment', 'care recipient', 'government subsidy', 'income-tested care fee', 'basic daily fee', 'additional service fees'] }
  ];

  document.addEventListener('DOMContentLoaded', () => {
    const contentElement = document.querySelector('.post-content');
    if (!contentElement) return;

    const linkedServices = new Set<string>();

    serviceKeywords.forEach(service => {
      if (linkedServices.has(service.slug)) return;

      for (const keyword of service.keywords) {
        if (linkedServices.has(service.slug) ||
            contentElement.innerHTML.includes(`href="/services/${service.slug}"`)) {
          break;
        }

        const textNodes: Node[] = [];
        const walker = document.createTreeWalker(
          contentElement,
          NodeFilter.SHOW_TEXT,
          null
        );

        let node: Node | null;
        while (node = walker.nextNode()) {
          const nodeValue = node.nodeValue;
          const parentElement = node.parentElement;

          if (nodeValue &&
              parentElement &&
              nodeValue.toLowerCase().includes(keyword.toLowerCase()) &&
              parentElement.nodeName !== 'A') {
            textNodes.push(node);
          }
        }

        if (textNodes.length > 0) {
          const firstNode = textNodes[0];
          const nodeText = firstNode.nodeValue;
          const parentNode = firstNode.parentNode;

          if (nodeText && parentNode) {
            const keywordRegex = new RegExp(`\\b${escapeRegExp(keyword)}\\b`, 'i');
            const match = nodeText.match(keywordRegex);

            if (match && match.index !== undefined) {
              const matchIndex = match.index;
              const beforeText = nodeText.substring(0, matchIndex);
              const matchedText = match[0];
              const afterText = nodeText.substring(matchIndex + matchedText.length);

              const beforeTextNode = document.createTextNode(beforeText);
              const linkElement = document.createElement('a');
              linkElement.href = `/services/${service.slug}`;
              linkElement.textContent = matchedText;
              linkElement.className = 'text-primary font-bold hover:underline';
              const afterTextNode = document.createTextNode(afterText);

              parentNode.insertBefore(beforeTextNode, firstNode);
              parentNode.insertBefore(linkElement, firstNode);
              parentNode.insertBefore(afterTextNode, firstNode);
              parentNode.removeChild(firstNode);

              linkedServices.add(service.slug);
              break;
            }
          }
        }
      }
    });
  });

  function escapeRegExp(string: string): string {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }
</script>
