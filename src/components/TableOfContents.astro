---
export interface Props {
  headings: {
    depth: number;
    slug: string;
    text: string;
  }[];
}

const { headings } = Astro.props;

// Filter only h2 headings for a cleaner TOC
const toc = headings.filter(heading => heading.depth === 2);
---

{toc.length > 0 && (
  <nav class="hidden lg:block">
    <h4 class="text-base font-semibold text-base-content mb-4">On this page</h4>
    <ul class="flex flex-col gap-2">
      {toc.map((heading) => (
        <li>
          <a
            href={`#${heading.slug}`}
            class="toc-link block text-base text-base-content/70 hover:text-primary truncate"
            data-heading-id={heading.slug}
            title={heading.text}
          >
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
  </nav>
)}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tocLinks = document.querySelectorAll('.toc-link');
    const observerOptions = {
      rootMargin: '-100px 0px -70% 0px',
      threshold: 0
    };

    const headingObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        const id = entry.target.getAttribute('id');
        const link = document.querySelector(`.toc-link[data-heading-id="${id}"]`);

        if (link) {
          if (entry.isIntersecting) {
            tocLinks.forEach(l => {
              l.classList.remove('text-primary', 'font-semibold');
              l.classList.add('text-base-content/60');
            });
            link.classList.remove('text-base-content/60');
            link.classList.add('text-primary', 'font-semibold');
          }
        }
      });
    }, observerOptions);

    document.querySelectorAll('h2[id]').forEach(heading => {
      headingObserver.observe(heading);
    });
  });
</script>
