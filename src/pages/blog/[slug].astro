---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import TableOfContents from '../../components/TableOfContents.astro';

// Generate static paths for all blog posts
export async function getStaticPaths() {
  const blogEntries = await getCollection('blog');
  return blogEntries.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

// Get the blog post for the current page
const { entry } = Astro.props;
const { Content, headings } = await entry.render();

// Generate JSON-LD structured data for the article
const articleSchema: {
  "@context": string;
  "@type": string;
  headline: string;
  datePublished: string;
  author: {
    "@type": string;
    name: string;
  };
  publisher: {
    "@type": string;
    name: string;
    logo: {
      "@type": string;
      url: string;
    };
  };
  description: string;
  image: string | undefined;
  mainEntityOfPage: {
    "@type": string;
    "@id": string;
  };
  hasPart?: Array<{
    "@type": string;
    isAccessibleForFree: string;
    cssSelector: string;
    name: string;
  }>;
} = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": entry.data.title,
  "datePublished": entry.data.pubDate.toISOString(),
  "author": {
    "@type": "Person",
    "name": entry.data.author
  },
  "publisher": {
    "@type": "Organization",
    "name": "MD Homecare",
    "logo": {
      "@type": "ImageObject",
      "url": new URL('/src/assets/logo.svg', Astro.url).toString()
    }
  },
  "description": entry.data.description,
  "image": entry.data.image,
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": Astro.url.href
  }
};

// Add table of contents to structured data if headings exist
if (headings && headings.length > 0) {
  const tocHeadings = headings.filter(h => h.depth === 2 || h.depth === 3);

  if (tocHeadings.length > 0) {
    articleSchema.hasPart = tocHeadings.map(heading => ({
      "@type": "WebPageElement",
      "isAccessibleForFree": "True",
      "cssSelector": `#${heading.slug}`,
      "name": heading.text
    }));
  }
}

const structuredData = JSON.stringify(articleSchema);
const canonicalUrl = new URL(`/blog/${entry.slug}`, Astro.site).toString();
---

<BaseLayout
  title={`${entry.data.title} | MD Homecare`}
  description={entry.data.description}
  image={entry.data.image}
  canonical={canonicalUrl}
>
  <script type="application/ld+json" set:html={structuredData} />

  <div class="max-w-5xl mx-auto px-4 py-8 lg:py-12">
    <article>
      <!-- Header -->
      <header class="mb-8">
        <h1 class="text-3xl lg:text-4xl font-bold text-base-content mb-6 leading-tight">
          {entry.data.title}
        </h1>

        <!-- E-E-A-T Authority Indicators -->
        <div class="bg-base-200 rounded-xl p-4 lg:p-6 border border-base-300">
          <div class="flex flex-col lg:flex-row lg:items-center gap-4 lg:gap-8">
            <!-- Author Profile -->
            <div class="flex items-center gap-4">
              <div class="avatar">
                <div class="w-14 lg:w-16 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                  <img src="/assets/avatar.webp" alt={`${entry.data.author} profile photo`} />
                </div>
              </div>
              <div>
                <p class="font-semibold text-base-content">{entry.data.author}</p>
                <p class="text-sm text-base-content/60">Healthcare Expert</p>
              </div>
            </div>

            <!-- Verified Badge -->
            <div class="flex items-center gap-2 text-success">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
              <span class="font-medium text-sm">Verified Article</span>
            </div>

            <!-- Meta Info -->
            <div class="flex flex-wrap items-center gap-4 text-sm text-base-content/60 lg:ml-auto">
              <div class="flex items-center gap-1.5">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <span>8 min read</span>
              </div>
              <div class="flex items-center gap-1.5">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <span>{entry.data.pubDate.toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric'
                })}</span>
              </div>
            </div>
          </div>
        </div>
      </header>

      <!-- Featured Image -->
      {entry.data.image && (
        <figure class="mb-8 rounded-xl overflow-hidden">
          <img src={entry.data.image} alt={entry.data.title} class="w-full h-auto max-h-96 object-cover" />
        </figure>
      )}

      <!-- Content with TOC -->
      <div class="lg:grid lg:grid-cols-[220px_1fr] lg:gap-8">
        <!-- Table of Contents Sidebar -->
        <aside class="lg:sticky lg:top-20 lg:h-fit mb-8 lg:mb-0">
          <TableOfContents headings={headings} />
        </aside>

        <!-- Article Content -->
        <div class="prose prose-slate max-w-none post-content">
          <Content />
        </div>
      </div>
    </article>
  </div>
</BaseLayout>

<script>
  // Service keywords to match and link
  interface ServiceKeyword {
    slug: string;
    keywords: string[];
  }

  const serviceKeywords: ServiceKeyword[] = [
    { slug: 'clinical-care', keywords: ['clinical care', 'nursing services', 'wound care', 'medication administration', 'catheter care', 'ostomy care', 'diabetic management', 'health assessments', 'vital signs monitoring', 'medical assessment', 'nursing care', 'high-intensity personal activities', 'medication management', 'monitoring of medical conditions', 'complex medical needs'] },
    { slug: 'personal-care', keywords: ['personal care', 'bathing assistance', 'grooming assistance', 'personal hygiene', 'showering assistance', 'dressing assistance', 'oral hygiene', 'toileting assistance', 'medication reminders', 'personal care services', 'continence management', 'personal support'] },
    { slug: 'domestic-assistance', keywords: ['domestic assistance', 'household tasks', 'home help', 'cleaning services', 'meal preparation', 'laundry services', 'gardening services', 'shopping assistance', 'household chores', 'domestic support', 'household maintenance', 'domestic help', 'daily household tasks'] },
    { slug: 'respite-care', keywords: ['respite care', 'respite services', 'carer relief', 'short-term care', 'in-home respite', 'short term accommodation', 'STA', 'respite costs', 'carer support', 'respite funding', 'short term respite'] },
    { slug: 'disability-services', keywords: ['disability support', 'disability services', 'NDIS support', 'daily living assistance', 'NDIS funding', 'disability assistance', 'person-centered approach', 'NDIS provider', 'NDIS business', 'people with disability', 'participant-focused', 'participant plans', 'intermediate care needs', 'NDIS participants', 'disability support services'] },
    { slug: 'support-workers', keywords: ['support workers', 'care workers', 'disability support workers', 'NDIS support worker', 'independent support worker', 'support staff', 'care staff', 'support worker rates', 'support worker pay', 'key personnel', 'staffing solutions', 'hiring compliant staff', 'aged care worker', 'care worker qualifications', 'qualified support workers'] },
    { slug: 'sil-services', keywords: ['supported independent living', 'SIL', 'supported accommodation', 'group homes', 'shared living support', 'disability accommodation', 'independent living support', 'supported living services', 'SIL services'] },
    { slug: 'disability-home-support-services', keywords: ['disability home support', 'home modifications', 'housing support', 'in-home support', 'home-based care', 'disability home care', 'home support services', 'assistive products', 'living independently', 'home care assistance'] },
    { slug: 'aged-care-home-modifications-maintenance', keywords: ['home modifications', 'aged care modifications', 'accessibility modifications', 'home maintenance', 'bathroom modifications', 'kitchen modifications', 'ramps installation', 'handrails installation', 'home modification services', 'premises fit-out', 'safety enhancements', 'accessibility improvements'] },
    { slug: 'therapy-services', keywords: ['therapy services', 'physiotherapy', 'occupational therapy', 'speech therapy', 'rehabilitation services', 'behavioral therapy', 'psychology services', 'exercise physiology', 'counselling services', 'dietetics', 'social work', 'therapeutic supports', 'specialized expertise', 'allied health services', 'podiatry services'] },
    { slug: 'transport-services', keywords: ['transport services', 'disability transport', 'assisted transport', 'medical transport', 'transportation assistance', 'NDIS transport funding', 'mobility support', 'transport funding', 'social and recreational activities', 'transport to appointments', 'transport to social events'] },
    { slug: 'specialist-disability-accommodation', keywords: ['specialist disability accommodation', 'SDA', 'disability housing', 'accessible housing', 'improved liveability', 'SDA funding', 'NDIS housing', 'accessible accommodation'] },
    { slug: 'community-access-support', keywords: ['community access', 'social participation', 'community inclusion', 'community activities', 'social support', 'social skills development', 'community engagement', 'recreational activities', 'community participation', 'community participation support', 'community networking', 'community services', 'community connections', 'staying active and connected'] },
    { slug: 'ndis-specialist-support-coordination', keywords: ['support coordination', 'NDIS coordination', 'disability coordination', 'NDIS planning', 'plan management', 'specialist support coordination', 'service coordination', 'support coordinators', 'local area coordinators', 'LACs', 'service agreements', 'care plan coordination', 'chosen provider'] },
    { slug: 'ndis-behaviour-support-practitioner-training', keywords: ['behavior support', 'behaviour support', 'positive behavior support', 'behavior management', 'behavior practitioner', 'behavioral strategies', 'behavioral intervention', 'behaviour support services', 'safeguarding practices', 'NDIS Practice Standards', 'NDIS Code of Conduct'] },
    { slug: 'home-care-packages', keywords: ['home care package', 'level 3 home care package', 'level 1 home care package', 'level 2 home care package', 'level 4 home care package', 'consumer-directed care', 'aged care assessment team', 'ACAT assessment', 'my aged care', 'commonwealth home support programme', 'support at home program', 'care needs assessment', 'care recipient', 'government subsidy', 'income-tested care fee', 'basic daily fee', 'additional service fees'] }
  ];

  document.addEventListener('DOMContentLoaded', () => {
    const contentElement = document.querySelector('.post-content');
    if (!contentElement) return;

    const linkedServices = new Set<string>();

    serviceKeywords.forEach(service => {
      if (linkedServices.has(service.slug)) return;

      for (const keyword of service.keywords) {
        if (linkedServices.has(service.slug) ||
            contentElement.innerHTML.includes(`href="/services/${service.slug}"`)) {
          break;
        }

        const textNodes: Node[] = [];
        const walker = document.createTreeWalker(
          contentElement,
          NodeFilter.SHOW_TEXT,
          null
        );

        let node: Node | null;
        while (node = walker.nextNode()) {
          const nodeValue = node.nodeValue;
          const parentElement = node.parentElement;

          if (nodeValue &&
              parentElement &&
              nodeValue.toLowerCase().includes(keyword.toLowerCase()) &&
              parentElement.nodeName !== 'A') {
            textNodes.push(node);
          }
        }

        if (textNodes.length > 0) {
          const firstNode = textNodes[0];
          const nodeText = firstNode.nodeValue;
          const parentNode = firstNode.parentNode;

          if (nodeText && parentNode) {
            const keywordRegex = new RegExp(`\\b${escapeRegExp(keyword)}\\b`, 'i');
            const match = nodeText.match(keywordRegex);

            if (match && match.index !== undefined) {
              const matchIndex = match.index;
              const beforeText = nodeText.substring(0, matchIndex);
              const matchedText = match[0];
              const afterText = nodeText.substring(matchIndex + matchedText.length);

              const beforeTextNode = document.createTextNode(beforeText);
              const linkElement = document.createElement('a');
              linkElement.href = `/services/${service.slug}`;
              linkElement.textContent = matchedText;
              linkElement.className = 'link link-primary';
              const afterTextNode = document.createTextNode(afterText);

              parentNode.insertBefore(beforeTextNode, firstNode);
              parentNode.insertBefore(linkElement, firstNode);
              parentNode.insertBefore(afterTextNode, firstNode);
              parentNode.removeChild(firstNode);

              linkedServices.add(service.slug);
              break;
            }
          }
        }
      }
    });
  });

  function escapeRegExp(string: string): string {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }
</script>

<style is:global>
  @reference "../../styles/global.css";
  /* Post content prose styling */
  .post-content {
    @apply text-base-content leading-relaxed;
  }

  .post-content h1 {
    @apply text-3xl font-bold mt-10 mb-6 text-base-content;
  }

  .post-content h2 {
    @apply text-2xl font-bold mt-8 mb-4 text-base-content pb-2 border-b border-base-300;
  }

  .post-content h3 {
    @apply text-xl font-semibold mt-6 mb-3 text-base-content;
  }

  .post-content h4 {
    @apply text-lg font-semibold mt-5 mb-3 text-base-content;
  }

  .post-content p {
    @apply mb-5;
    color: oklch(var(--bc) / 0.9);
  }

  .post-content ul,
  .post-content ol {
    @apply mb-5 pl-6;
  }

  .post-content ul {
    @apply list-disc;
  }

  .post-content ol {
    @apply list-decimal;
  }

  .post-content li {
    @apply mb-2;
    color: oklch(var(--bc) / 0.9);
  }

  .post-content li > ul,
  .post-content li > ol {
    @apply mt-2 mb-2 pl-5;
  }

  .post-content a {
    @apply link link-primary;
  }

  .post-content blockquote {
    @apply border-l-4 border-primary pl-4 py-2 my-6 bg-base-200 rounded-r-lg italic;
  }

  .post-content blockquote p {
    @apply mb-2;
  }

  .post-content blockquote p:last-child {
    @apply mb-0;
  }

  .post-content code {
    @apply bg-base-200 px-1.5 py-0.5 rounded text-sm font-mono text-primary;
  }

  .post-content pre {
    @apply bg-neutral text-neutral-content p-4 rounded-lg overflow-x-auto mb-5;
  }

  .post-content pre code {
    @apply bg-transparent p-0 text-inherit;
  }

  .post-content img {
    @apply max-w-full h-auto rounded-lg my-4;
  }

  .post-content hr {
    @apply border-base-300 my-8;
  }

  .post-content strong {
    @apply font-semibold text-base-content;
  }

  .post-content em {
    @apply italic;
  }

  /* Tables */
  .post-content table {
    @apply w-full border-collapse mb-6 text-sm;
  }

  .post-content th,
  .post-content td {
    @apply p-3 text-left border-b border-base-300;
  }

  .post-content th {
    @apply bg-base-200 font-semibold;
  }

  .post-content tr:hover {
    background-color: oklch(var(--b2) / 0.5);
  }
</style>
