stages:
  - build
  - deploy

variables:
  NODE_OPTIONS: "--max-old-space-size=4096"

# ──────────────────────────────────────────────
# Build Stage
# ──────────────────────────────────────────────
build:
  stage: build
  image: meetrix/website-build-container
  before_script:
    - n 20.16.0
    - node -v
    - npm ci
  script:
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 month
  resource_group: production
  only:
    - main

# ──────────────────────────────────────────────
# Deploy Stage — Cloudflare R2 + Cache Purge
# ──────────────────────────────────────────────
deploy:
  stage: deploy
  image: meetrix/website-build-container
  dependencies:
    - build
  before_script:
    - export AWS_ACCESS_KEY_ID="$R2_ACCESS_KEY_ID"
    - export AWS_SECRET_ACCESS_KEY="$R2_SECRET_ACCESS_KEY"
  script:
    # Upload dist/ to R2 bucket
    - >
      aws s3 cp dist/ "s3://$R2_BUCKET_NAME/"
      --recursive
      --endpoint-url "$R2_ENDPOINT_URL"
      --quiet

    # Purge Cloudflare cache
    - >
      curl -s -X POST
      "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/purge_cache"
      -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN"
      -H "Content-Type: application/json"
      --data '{"purge_everything":true}'

    - echo "Deployed to $PUBLIC_API_BASE_URL"
  resource_group: production
  only:
    - main
