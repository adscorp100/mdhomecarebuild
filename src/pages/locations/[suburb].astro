---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { Icon } from 'astro-icon/components';
import suburbsData from '../../data/suburbs-data.json';
import suburbDetails from '../../data/suburb-details.json';
import regionContent from '../../data/region-content.json';
import suburbTestimonials from '../../data/suburb-testimonials.json';
import suburbCoordinates from '../../data/suburb-coordinates.json';

// Generate static paths for all suburbs
export async function getStaticPaths() {
  const suburbsDataImport = await import('../../data/suburbs-data.json');
  const suburbs = suburbsDataImport.default;

  return Object.keys(suburbs).map(suburb => ({
    params: { suburb },
    props: { suburbInfo: suburbs[suburb] }
  }));
}

const { suburb } = Astro.params;
const { suburbInfo } = Astro.props;

// Get suburb display name
const suburbData = suburbDetails[suburb as keyof typeof suburbDetails];
const suburbName = suburbData?.displayName || suburb!.split('-').map((word: string) => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

// Get region data
const regionKey = suburbInfo.region.toLowerCase().replace(/\s+/g, '-');
const regionData = regionContent[regionKey as keyof typeof regionContent];

// Get all services
const allServices = await getCollection('services');
const sortedServices = allServices.sort((a, b) => a.data.title.localeCompare(b.data.title));

// Group services by category
const servicesByCategory: Record<string, typeof allServices> = sortedServices.reduce((acc, service) => {
  const category = service.data.category;
  if (!acc[category]) {
    acc[category] = [];
  }
  acc[category].push(service);
  return acc;
}, {} as Record<string, typeof allServices>);

const sortedCategories = Object.keys(servicesByCategory).sort();

// Get testimonials for this suburb
const testimonials = suburbTestimonials[suburb as keyof typeof suburbTestimonials] || [];

// State name mapping
const stateNames: Record<string, string> = {
  "NSW": "New South Wales",
  "VIC": "Victoria",
  "QLD": "Queensland",
  "WA": "Western Australia",
  "SA": "South Australia",
  "TAS": "Tasmania",
  "ACT": "Australian Capital Territory",
  "NT": "Northern Territory"
};

// Optimized meta title (under 60 chars with brand)
const title = `Home Care & NDIS in ${suburbName}`;
const description = `Find quality home care and NDIS services in ${suburbName}, ${stateNames[suburbInfo.state]}. Personal care, domestic assistance, disability support. Local carers, flexible scheduling. Call 08 6386 9999.`;

// H1 can be slightly longer
const h1Title = `Home Care & NDIS Services in ${suburbName}`;

// Get suburb coordinates for geo positioning
const coords = suburbCoordinates[suburb as keyof typeof suburbCoordinates] || { lat: "-33.8688", lng: "151.2093" };

// Schema markup
const locationSchema = {
  "@context": "https://schema.org",
  "@type": "LocalBusiness",
  "name": `MD Home Care - ${suburbName}`,
  "description": description,
  "url": Astro.url.href,
  "telephone": "+61863869999",
  "email": "contact@mdhomecare.com.au",
  "priceRange": "$$",
  "geo": {
    "@type": "GeoCoordinates",
    "latitude": coords.lat,
    "longitude": coords.lng
  },
  "openingHoursSpecification": {
    "@type": "OpeningHoursSpecification",
    "dayOfWeek": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"],
    "opens": "00:00",
    "closes": "23:59"
  },
  "areaServed": {
    "@type": "City",
    "name": suburbName,
    "containedInPlace": {
      "@type": "State",
      "name": stateNames[suburbInfo.state]
    }
  },
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "4.8",
    "reviewCount": "127",
    "bestRating": "5"
  }
};
---

<script type="application/ld+json" set:html={JSON.stringify(locationSchema)}></script>

<BaseLayout title={title} description={description}>
  <div class="max-w-6xl mx-auto px-4 py-12">
    <nav class="text-sm mb-8" aria-label="Breadcrumb">
      <ol class="flex items-center gap-2">
        <li><a href="/" class="text-primary hover:underline">Home</a></li>
        <li><span class="text-base-content/40">/</span></li>
        <li><a href="/locations" class="text-primary hover:underline">Locations</a></li>
        <li><span class="text-base-content/40">/</span></li>
        <li class="text-base-content/70">{suburbName}</li>
      </ol>
    </nav>

    <header class="mb-12">
      <div class="flex flex-wrap gap-2 mb-4">
        <span class="badge badge-primary badge-lg">{suburbInfo.region}</span>
        <span class="badge badge-outline badge-lg">{stateNames[suburbInfo.state]}</span>
      </div>

      <h1 class="text-4xl font-bold text-base-content mb-4">
        {h1Title}
      </h1>

      <p class="text-lg text-base-content/70 max-w-3xl mb-6">
        MD Home Care provides quality in-home care and NDIS support services throughout {suburbName} and the {suburbInfo.region} region.
        Our local team of qualified carers understands your community and delivers consistent, compassionate support.
      </p>

      {suburbData && (
        <div class="flex flex-wrap gap-3 mb-6">
          {suburbData.postcode && (
            <span class="badge badge-ghost">Postcode: {suburbData.postcode}</span>
          )}
          {suburbData.localCouncil && (
            <span class="badge badge-ghost">{suburbData.localCouncil}</span>
          )}
          {suburbData.nearestHospital && (
            <span class="badge badge-ghost">Near {suburbData.nearestHospital}</span>
          )}
        </div>
      )}

      <div class="flex flex-col sm:flex-row gap-4">
        <a href="/contact" class="btn btn-primary btn-lg">
          Get a Free Consultation
        </a>
        <a href="tel:+61863869999" class="btn btn-outline btn-lg">
          Call 08 6386 9999
        </a>
      </div>
    </header>

    {regionData && (
      <div class="bg-base-200 border border-base-300 rounded-box p-6 mb-12">
        <h2 class="text-lg font-bold text-base-content mb-3">
          Our {suburbInfo.region} Team
        </h2>
        <p class="text-base-content/80">{regionData.localInsight}</p>
      </div>
    )}

    <section class="mb-16">
      <h2 class="text-2xl font-bold text-base-content mb-6">
        All Services Available in {suburbName}
      </h2>

      <div class="space-y-12">
        {sortedCategories.map((category) => (
          <div>
            <h3 class="text-xl font-semibold text-base-content mb-4 pb-2 border-b border-base-300">
              {category}
              <span class="text-sm font-normal text-base-content/60 ml-2">
                ({servicesByCategory[category].length} services)
              </span>
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {servicesByCategory[category].map((service) => (
                <a
                  href={`/services/${service.slug}/${suburb}`}
                  class="card bg-base-100 shadow hover:shadow-lg transition-all duration-300 hover:-translate-y-1 border border-base-200"
                >
                  <div class="card-body p-4">
                    <h4 class="card-title text-base">
                      {service.data.title.replace(/{suburb}/g, '').trim()}
                    </h4>
                    {service.data.quickFacts?.costRange && (
                      <p class="text-sm text-primary font-medium">
                        {service.data.quickFacts.costRange.split('(')[0].trim()}
                      </p>
                    )}
                    <span class="text-primary text-sm">
                      View in {suburbName} →
                    </span>
                  </div>
                </a>
              ))}
            </div>
          </div>
        ))}
      </div>
    </section>

    {testimonials.length > 0 && (
      <section class="bg-base-200 rounded-box p-8 mb-16">
        <h2 class="text-2xl font-bold text-base-content mb-6">
          What Our Clients in {suburbName} Say
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          {testimonials.slice(0, 2).map((testimonial: { name: string; quote: string; rating: number }) => (
            <div class="bg-base-100 rounded-lg p-6 border border-base-300">
              <div class="text-warning mb-2 flex gap-0.5">
                {Array(5).fill(0).map((_, i) => (
                  <Icon
                    name="hugeicons:star"
                    class={`h-5 w-5 ${i < testimonial.rating ? 'fill-current' : 'opacity-30'}`}
                  />
                ))}
              </div>
              <blockquote class="text-base-content/80 italic mb-4">
                "{testimonial.quote}"
              </blockquote>
              <p class="font-medium text-base-content">
                — {testimonial.name}, {suburbName}
              </p>
            </div>
          ))}
        </div>
      </section>
    )}

    {suburbData && (suburbData.medicalCentres || suburbData.communityGroups) && (
      <section class="mb-16">
        <h2 class="text-2xl font-bold text-base-content mb-6">
          Local Resources in {suburbName}
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {suburbData.medicalCentres && (
            <div class="card bg-base-100 border border-base-300">
              <div class="card-body">
                <h3 class="card-title text-lg">Medical Centres</h3>
                <ul class="text-sm text-base-content/70 space-y-1">
                  {(suburbData.medicalCentres as string[]).slice(0, 3).map((centre: string) => (
                    <li>{centre}</li>
                  ))}
                </ul>
              </div>
            </div>
          )}

          {suburbData.pharmacies && (
            <div class="card bg-base-100 border border-base-300">
              <div class="card-body">
                <h3 class="card-title text-lg">Pharmacies</h3>
                <ul class="text-sm text-base-content/70 space-y-1">
                  {(suburbData.pharmacies as string[]).slice(0, 3).map((pharmacy: string) => (
                    <li>{pharmacy}</li>
                  ))}
                </ul>
              </div>
            </div>
          )}

          {suburbData.communityGroups && (
            <div class="card bg-base-100 border border-base-300">
              <div class="card-body">
                <h3 class="card-title text-lg">Community Groups</h3>
                <ul class="text-sm text-base-content/70 space-y-1">
                  {(suburbData.communityGroups as string[]).slice(0, 3).map((group: string) => (
                    <li>{group}</li>
                  ))}
                </ul>
              </div>
            </div>
          )}
        </div>
      </section>
    )}

    <section class="bg-primary text-primary-content rounded-box p-8 text-center">
      <h2 class="text-2xl font-bold mb-4">Ready to Get Care in {suburbName}?</h2>
      <p class="mb-6 text-primary-content/90 max-w-2xl mx-auto">
        We can connect you with providers in the {suburbInfo.region} area. Get a free, no-obligation consultation
        to discuss your care needs and funding options.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href="/contact" class="btn bg-white text-primary hover:bg-white/90">
          Book Free Consultation
        </a>
        <a href="tel:+61863869999" class="btn btn-outline border-white text-white hover:bg-white hover:text-primary">
          Call 08 6386 9999
        </a>
      </div>
    </section>
  </div>
</BaseLayout>
