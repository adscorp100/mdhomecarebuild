stages:
  - build
  - deploy

variables:
  NODE_OPTIONS: "--max-old-space-size=4096"

# ──────────────────────────────────────────────
# Build Stage
# ──────────────────────────────────────────────
build:
  stage: build
  image: meetrix/website-build-container
  before_script:
    - n 20.16.0
    - node -v
    - npm ci
  script:
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 month
  resource_group: production
  # Temporarily disabled for testing - re-enable after testing
  # only:
  #   - main

# ──────────────────────────────────────────────
# Deploy Stage — Cloudflare R2 + Cache Purge
# ──────────────────────────────────────────────
deploy:
  stage: deploy
  image:
    name: rclone/rclone:latest
    entrypoint: [""]
  dependencies:
    - build
  before_script:
    # Configure rclone for Cloudflare R2
    - |
      mkdir -p ~/.config/rclone
      cat > ~/.config/rclone/rclone.conf <<EOF
      [r2]
      type = s3
      provider = Cloudflare
      access_key_id = $R2_ACCESS_KEY_ID
      secret_access_key = $R2_SECRET_ACCESS_KEY
      endpoint = $R2_ENDPOINT_URL
      acl = private
      EOF
  script:
    # Upload dist/ to R2 bucket with rclone (fast, concurrent)
    - >
      rclone sync dist/ r2:$R2_BUCKET_NAME/
      --fast-list
      --transfers=32
      --checkers=16
      --progress

    # Purge Cloudflare cache
    - >
      curl -s -X POST
      "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/purge_cache"
      -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN"
      -H "Content-Type: application/json"
      --data '{"purge_everything":true}'

    - echo "Deployed to $PUBLIC_API_BASE_URL"
  resource_group: production
  # Temporarily disabled for testing - re-enable after testing
  # only:
  #   - main
