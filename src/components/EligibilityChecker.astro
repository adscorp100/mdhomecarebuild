---
// Eligibility Checker Component - DaisyUI Version
import { Icon } from 'astro-icon/components';
---

<div class="card bg-base-100 shadow-xl border border-base-300 eligibility-checker-card" id="eligibility-checker">
  <div class="card-body">
    <!-- Header -->
    <div class="text-center mb-6">
      <h2 class="card-title text-2xl font-bold justify-center mb-2">Check Eligibility</h2>
      <p class="text-base-content/70">Take our quick assessment to find out if you or your loved one qualifies for support. It only takes a minute.</p>
    </div>

    <!-- Progress -->
    <div class="mb-6">
      <progress class="progress progress-primary w-full" value="25" max="100"></progress>
      <p class="text-sm text-base-content/60 text-right mt-1 progress-text">Step 1 of 4</p>
    </div>

    <form id="eligibility-checker-form" class="eligibility-checker-form">
      <!-- Question 1: Age -->
      <div class="question-screen" id="question-1" data-index="1">
        <h3 class="text-xl font-semibold mb-4">What is the age of the person needing support?</h3>

        <div class="form-control mb-6">
          <!-- Age Preset Buttons -->
          <div class="flex flex-wrap gap-2 justify-center mb-4">
            <button type="button" class="btn btn-outline btn-sm age-preset-btn" data-age="18">Under 18</button>
            <button type="button" class="btn btn-outline btn-sm age-preset-btn" data-age="30">18-30</button>
            <button type="button" class="btn btn-outline btn-sm age-preset-btn" data-age="45">31-45</button>
            <button type="button" class="btn btn-outline btn-sm age-preset-btn" data-age="60">46-60</button>
            <button type="button" class="btn btn-outline btn-sm age-preset-btn" data-age="75">61+</button>
          </div>

          <!-- Age Input -->
          <label class="label">
            <span class="label-text text-base-content/70">Or enter exact age:</span>
          </label>
          <input type="number" id="age" name="age" min="0" max="120" required
            class="input input-bordered w-full" placeholder="Enter age" />
        </div>

        <div class="flex justify-end">
          <button type="button" class="btn btn-primary next-button" data-next="2">Continue</button>
        </div>
      </div>

      <!-- Question 2: NDIS Funding -->
      <div class="question-screen hidden" id="question-2" data-index="2">
        <h3 class="text-xl font-semibold mb-4">Does the person already receive NDIS funding?</h3>

        <div class="form-control space-y-3 mb-6">
          <label class="label cursor-pointer justify-start gap-4 p-4 border border-base-300 rounded-lg hover:bg-base-200 transition-colors">
            <input type="radio" name="ndis_funding" value="yes" class="radio radio-primary" required />
            <span class="label-text text-base">Yes</span>
          </label>
          <label class="label cursor-pointer justify-start gap-4 p-4 border border-base-300 rounded-lg hover:bg-base-200 transition-colors">
            <input type="radio" name="ndis_funding" value="no" class="radio radio-primary" />
            <span class="label-text text-base">No</span>
          </label>
          <label class="label cursor-pointer justify-start gap-4 p-4 border border-base-300 rounded-lg hover:bg-base-200 transition-colors">
            <input type="radio" name="ndis_funding" value="not_sure" class="radio radio-primary" />
            <span class="label-text text-base">Not sure</span>
          </label>
        </div>

        <div class="flex justify-between gap-3">
          <button type="button" class="btn btn-ghost back-button" data-prev="1">Back</button>
          <button type="button" class="btn btn-primary next-button" data-next="3">Continue</button>
        </div>
      </div>

      <!-- Question 3: Disability -->
      <div class="question-screen hidden" id="question-3" data-index="3">
        <h3 class="text-xl font-semibold mb-4">Does the person have a diagnosed disability or chronic condition?</h3>

        <div class="form-control space-y-3 mb-6">
          <label class="label cursor-pointer justify-start gap-4 p-4 border border-base-300 rounded-lg hover:bg-base-200 transition-colors">
            <input type="radio" name="disability" value="yes" class="radio radio-primary" required />
            <span class="label-text text-base">Yes</span>
          </label>
          <label class="label cursor-pointer justify-start gap-4 p-4 border border-base-300 rounded-lg hover:bg-base-200 transition-colors">
            <input type="radio" name="disability" value="no" class="radio radio-primary" />
            <span class="label-text text-base">No</span>
          </label>
          <label class="label cursor-pointer justify-start gap-4 p-4 border border-base-300 rounded-lg hover:bg-base-200 transition-colors">
            <input type="radio" name="disability" value="not_sure" class="radio radio-primary" />
            <span class="label-text text-base">Not sure</span>
          </label>
        </div>

        <div class="flex justify-between gap-3">
          <button type="button" class="btn btn-ghost back-button" data-prev="2">Back</button>
          <button type="button" class="btn btn-primary next-button" data-next="4">Continue</button>
        </div>
      </div>

      <!-- Question 4: Postcode -->
      <div class="question-screen hidden" id="question-4" data-index="4">
        <h3 class="text-xl font-semibold mb-4">What's the postcode where the person lives?</h3>

        <div class="form-control mb-6">
          <input type="text" id="postcode" name="postcode" pattern="[0-9]{4}" maxlength="4" required
            class="input input-bordered w-full" placeholder="e.g. 2000" />
          <label class="label">
            <span class="label-text-alt text-base-content/60">Please enter a valid Australian postcode (4 digits)</span>
          </label>
        </div>

        <div class="flex justify-between gap-3">
          <button type="button" class="btn btn-ghost back-button" data-prev="3">Back</button>
          <button type="button" class="btn btn-primary submit-results-btn">See Results</button>
        </div>
      </div>

      <!-- Results Screen -->
      <div class="question-screen hidden results-screen">
        <div class="text-center mb-8">
          <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-success/10 mb-4 results-icon-wrapper">
            <Icon name="hugeicons:checkmark-circle-02" class="h-8 w-8 text-success results-icon" />
          </div>
          <h3 class="text-2xl font-bold text-base-content mb-2">Assessment Complete</h3>
          <p class="text-base-content/70 results-message"></p>
        </div>

        <div class="bg-base-200 rounded-box p-6 mb-6">
          <p class="text-sm text-base-content/80 text-center">
            Our team is ready to help you navigate your options and find the right support.
          </p>
        </div>

        <div class="grid gap-3">
          <a href="tel:+61863869999" class="btn btn-primary btn-lg gap-2">
            <Icon name="hugeicons:call-02" class="h-5 w-5" />
            Call Us Now
          </a>
          <a href="/contact#contact-form" class="btn btn-outline gap-2">
            <Icon name="hugeicons:mail-01" class="h-5 w-5" />
            Send a Message
          </a>
          <button type="button" class="btn btn-ghost btn-sm mt-2 restart-button">
            Start Over
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<script is:inline>
  // Use event delegation on document body to handle cloned elements
  (function() {
    // Prevent multiple initializations
    if (window.__eligibilityCheckerInit) return;
    window.__eligibilityCheckerInit = true;

    var startTime = Date.now();
    var currentScreen = 1;
    var totalScreens = 4;

    var userResponses = {
      age: null,
      ndis_funding: null,
      disability: null,
      postcode: null
    };

    // Load saved responses
    var savedResponses = localStorage.getItem('eligibilityCheckerResponses');
    if (savedResponses) {
      try {
        Object.assign(userResponses, JSON.parse(savedResponses));
      } catch (e) {
        localStorage.removeItem('eligibilityCheckerResponses');
      }
    }

    function getContainer(el) {
      return el.closest('.eligibility-checker-card');
    }

    function updateProgress(container, screenIndex) {
      var progress = (screenIndex / totalScreens) * 100;
      var progressBar = container.querySelector('.progress');
      var progressText = container.querySelector('.progress-text');
      if (progressBar) progressBar.value = progress;
      if (progressText) progressText.textContent = 'Step ' + screenIndex + ' of ' + totalScreens;
    }

    function showScreen(container, screenIndex) {
      var screens = container.querySelectorAll('.question-screen');
      screens.forEach(function(screen) { screen.classList.add('hidden'); });

      var targetScreen = container.querySelector('[data-index="' + screenIndex + '"]');
      if (targetScreen) targetScreen.classList.remove('hidden');

      currentScreen = screenIndex;
      updateProgress(container, screenIndex);
    }

    function getAgeRange(age) {
      if (age < 18) return 'under_18';
      if (age < 30) return '18_29';
      if (age < 50) return '30_49';
      if (age < 65) return '50_64';
      return '65_plus';
    }

    function handleSubmitResults(container) {
      // Validate postcode
      var postcodeEl = container.querySelector('input[name="postcode"]');
      if (postcodeEl && !postcodeEl.value.trim()) {
        postcodeEl.classList.add('input-error');
        return;
      }
      if (postcodeEl && !/^[0-9]{4}$/.test(postcodeEl.value)) {
        postcodeEl.classList.add('input-error');
        return;
      }

      if (postcodeEl) userResponses.postcode = postcodeEl.value;
      localStorage.setItem('eligibilityCheckerResponses', JSON.stringify(userResponses));

      var age = parseInt(userResponses.age || '0');
      var hasDisability = userResponses.disability === 'yes';
      var resultMessage = '';
      var iconColor = 'text-success';
      var bgColor = 'bg-success/10';

      if (age > 65) {
        resultMessage = 'Based on your responses, the person may qualify for Aged Care services.';
        iconColor = 'text-warning';
        bgColor = 'bg-warning/10';
      } else if (age <= 65 && hasDisability) {
        resultMessage = 'Based on your responses, the person may be eligible for NDIS support.';
        iconColor = 'text-success';
        bgColor = 'bg-success/10';
      } else {
        resultMessage = 'Our specialists can help guide you through the options available.';
        iconColor = 'text-info';
        bgColor = 'bg-info/10';
      }

      var resultsMessage = container.querySelector('.results-message');
      var resultsScreen = container.querySelector('.results-screen');
      var resultsIconWrapper = container.querySelector('.results-icon-wrapper');
      var resultsIcon = container.querySelector('.results-icon');
      var progressBar = container.querySelector('.progress');
      var progressText = container.querySelector('.progress-text');

      if (resultsMessage) resultsMessage.textContent = resultMessage;

      if (resultsIconWrapper) {
        resultsIconWrapper.className = 'inline-flex items-center justify-center w-16 h-16 rounded-full mb-4 ' + bgColor;
      }
      if (resultsIcon) {
        resultsIcon.className = 'h-8 w-8 ' + iconColor;
      }

      container.querySelectorAll('.question-screen').forEach(function(screen) { screen.classList.add('hidden'); });
      if (resultsScreen) resultsScreen.classList.remove('hidden');
      if (progressBar) progressBar.value = 100;
      if (progressText) progressText.textContent = 'Complete!';

      var completionTime = (Date.now() - startTime) / 1000;

      if (typeof window.gtag === 'function') {
        window.gtag('event', 'eligibility_complete', {
          'service_type': 'ndis',
          'completion_time': completionTime,
          'age_range': getAgeRange(age),
          'has_disability': hasDisability
        });
      }
    }

    // Event delegation for all clicks
    document.addEventListener('click', function(e) {
      var target = e.target;
      var container = getContainer(target);
      if (!container) return;

      // Ignore clicks in the hidden template
      if (container.closest('.hidden') || container.closest('#eligibility-checker-template')) return;

      // Age preset buttons - auto advance
      if (target.classList.contains('age-preset-btn')) {
        e.preventDefault();
        var age = target.getAttribute('data-age');
        var ageInput = container.querySelector('input[name="age"]');
        if (ageInput && age) {
          ageInput.value = age;
        }
        container.querySelectorAll('.age-preset-btn').forEach(function(btn) {
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-outline');
        });
        target.classList.remove('btn-outline');
        target.classList.add('btn-primary');

        // Store response and auto-advance after short delay
        userResponses.age = age;
        localStorage.setItem('eligibilityCheckerResponses', JSON.stringify(userResponses));
        setTimeout(function() {
          showScreen(container, 2);
        }, 300);
        return;
      }

      // Next buttons
      if (target.classList.contains('next-button') || target.closest('.next-button')) {
        e.preventDefault();
        var btn = target.classList.contains('next-button') ? target : target.closest('.next-button');
        var currentQuestionScreen = container.querySelector('.question-screen:not(.hidden)');

        var valid = true;
        if (currentQuestionScreen) {
          var inputs = currentQuestionScreen.querySelectorAll('input[required]');
          inputs.forEach(function(input) {
            if (input.type === 'radio') {
              var radioGroup = input.name;
              if (!currentQuestionScreen.querySelector('input[name="' + radioGroup + '"]:checked')) {
                valid = false;
              }
            } else if (!input.value.trim()) {
              valid = false;
              input.classList.add('input-error');
            }
          });
        }

        if (!valid) return;

        // Store responses
        if (currentScreen === 1) {
          var ageEl = container.querySelector('input[name="age"]');
          if (ageEl) userResponses.age = ageEl.value;
        } else if (currentScreen === 2) {
          var radioEl = container.querySelector('input[name="ndis_funding"]:checked');
          if (radioEl) userResponses.ndis_funding = radioEl.value;
        } else if (currentScreen === 3) {
          var radioEl = container.querySelector('input[name="disability"]:checked');
          if (radioEl) userResponses.disability = radioEl.value;
        }

        localStorage.setItem('eligibilityCheckerResponses', JSON.stringify(userResponses));

        var nextScreen = parseInt(btn.getAttribute('data-next') || '0');
        showScreen(container, nextScreen);
        return;
      }

      // Back buttons
      if (target.classList.contains('back-button') || target.closest('.back-button')) {
        e.preventDefault();
        var btn = target.classList.contains('back-button') ? target : target.closest('.back-button');
        var prevScreen = parseInt(btn.getAttribute('data-prev') || '0');
        showScreen(container, prevScreen);
        return;
      }

      // Restart button
      if (target.classList.contains('restart-button') || target.closest('.restart-button')) {
        e.preventDefault();
        var form = container.querySelector('form');
        if (form) form.reset();
        container.querySelectorAll('.age-preset-btn').forEach(function(btn) {
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-outline');
        });
        currentScreen = 1;
        showScreen(container, 1);
        return;
      }

      // Submit results button
      if (target.classList.contains('submit-results-btn') || target.closest('.submit-results-btn')) {
        e.preventDefault();
        handleSubmitResults(container);
        return;
      }
    });

    // Remove error class on input
    document.addEventListener('input', function(e) {
      var target = e.target;
      if (target.tagName === 'INPUT') {
        target.classList.remove('input-error');
      }
    });

    // Auto-advance on radio button selection
    document.addEventListener('change', function(e) {
      var target = e.target;
      if (target.type !== 'radio') return;

      var container = getContainer(target);
      if (!container) return;
      if (container.closest('.hidden') || container.closest('#eligibility-checker-template')) return;

      var radioName = target.name;

      // Handle NDIS funding question (screen 2 -> 3)
      if (radioName === 'ndis_funding') {
        userResponses.ndis_funding = target.value;
        localStorage.setItem('eligibilityCheckerResponses', JSON.stringify(userResponses));
        setTimeout(function() {
          showScreen(container, 3);
        }, 300);
        return;
      }

      // Handle disability question (screen 3 -> 4)
      if (radioName === 'disability') {
        userResponses.disability = target.value;
        localStorage.setItem('eligibilityCheckerResponses', JSON.stringify(userResponses));
        setTimeout(function() {
          showScreen(container, 4);
        }, 300);
        return;
      }
    });
  })();
</script>
