---
// Eligibility Checker Component - DaisyUI Version
---

<div class="card bg-base-100 shadow-xl border border-base-300 max-w-2xl mx-auto my-8" id="eligibility-checker">
  <div class="card-body">
    <!-- Header -->
    <div class="text-center mb-6">
      <h2 class="card-title text-2xl font-bold justify-center mb-2">Check Eligibility</h2>
      <p class="text-base-content/70">Take our quick assessment to find out if you or your loved one qualifies for support. It only takes a minute.</p>
    </div>

    <!-- Progress -->
    <div class="mb-6">
      <progress class="progress progress-primary w-full" value="25" max="100" id="checker-progress-bar"></progress>
      <p class="text-sm text-base-content/60 text-right mt-1" id="progress-text">Step 1 of 4</p>
    </div>

    <form id="eligibility-checker-form">
      <!-- Question 1: Age -->
      <div class="question-screen" id="question-1" data-index="1">
        <h3 class="text-xl font-semibold mb-4">What is the age of the person needing support?</h3>

        <div class="form-control mb-6">
          <!-- Age Preset Buttons -->
          <div class="flex flex-wrap gap-2 justify-center mb-4">
            <button type="button" class="btn btn-outline btn-sm age-preset-btn" data-age="18">Under 18</button>
            <button type="button" class="btn btn-outline btn-sm age-preset-btn" data-age="30">18-30</button>
            <button type="button" class="btn btn-outline btn-sm age-preset-btn" data-age="45">31-45</button>
            <button type="button" class="btn btn-outline btn-sm age-preset-btn" data-age="60">46-60</button>
            <button type="button" class="btn btn-outline btn-sm age-preset-btn" data-age="75">61+</button>
          </div>

          <!-- Age Input -->
          <label class="label">
            <span class="label-text text-base-content/70">Or enter exact age:</span>
          </label>
          <input type="number" id="age" name="age" min="0" max="120" required
            class="input input-bordered w-full" placeholder="Enter age" />
        </div>

        <div class="flex justify-end">
          <button type="button" class="btn btn-primary next-button" data-next="2">Continue</button>
        </div>
      </div>

      <!-- Question 2: NDIS Funding -->
      <div class="question-screen hidden" id="question-2" data-index="2">
        <h3 class="text-xl font-semibold mb-4">Does the person already receive NDIS funding?</h3>

        <div class="form-control space-y-3 mb-6">
          <label class="label cursor-pointer justify-start gap-4 p-4 border border-base-300 rounded-lg hover:bg-base-200 transition-colors">
            <input type="radio" name="ndis_funding" value="yes" class="radio radio-primary" required />
            <span class="label-text text-base">Yes</span>
          </label>
          <label class="label cursor-pointer justify-start gap-4 p-4 border border-base-300 rounded-lg hover:bg-base-200 transition-colors">
            <input type="radio" name="ndis_funding" value="no" class="radio radio-primary" />
            <span class="label-text text-base">No</span>
          </label>
          <label class="label cursor-pointer justify-start gap-4 p-4 border border-base-300 rounded-lg hover:bg-base-200 transition-colors">
            <input type="radio" name="ndis_funding" value="not_sure" class="radio radio-primary" />
            <span class="label-text text-base">Not sure</span>
          </label>
        </div>

        <div class="flex justify-between gap-3">
          <button type="button" class="btn btn-ghost back-button" data-prev="1">Back</button>
          <button type="button" class="btn btn-primary next-button" data-next="3">Continue</button>
        </div>
      </div>

      <!-- Question 3: Disability -->
      <div class="question-screen hidden" id="question-3" data-index="3">
        <h3 class="text-xl font-semibold mb-4">Does the person have a diagnosed disability or chronic condition?</h3>

        <div class="form-control space-y-3 mb-6">
          <label class="label cursor-pointer justify-start gap-4 p-4 border border-base-300 rounded-lg hover:bg-base-200 transition-colors">
            <input type="radio" name="disability" value="yes" class="radio radio-primary" required />
            <span class="label-text text-base">Yes</span>
          </label>
          <label class="label cursor-pointer justify-start gap-4 p-4 border border-base-300 rounded-lg hover:bg-base-200 transition-colors">
            <input type="radio" name="disability" value="no" class="radio radio-primary" />
            <span class="label-text text-base">No</span>
          </label>
          <label class="label cursor-pointer justify-start gap-4 p-4 border border-base-300 rounded-lg hover:bg-base-200 transition-colors">
            <input type="radio" name="disability" value="not_sure" class="radio radio-primary" />
            <span class="label-text text-base">Not sure</span>
          </label>
        </div>

        <div class="flex justify-between gap-3">
          <button type="button" class="btn btn-ghost back-button" data-prev="2">Back</button>
          <button type="button" class="btn btn-primary next-button" data-next="4">Continue</button>
        </div>
      </div>

      <!-- Question 4: Postcode -->
      <div class="question-screen hidden" id="question-4" data-index="4">
        <h3 class="text-xl font-semibold mb-4">What's the postcode where the person lives?</h3>

        <div class="form-control mb-6">
          <input type="text" id="postcode" name="postcode" pattern="[0-9]{4}" maxlength="4" required
            class="input input-bordered w-full" placeholder="e.g. 2000" />
          <label class="label">
            <span class="label-text-alt text-base-content/60">Please enter a valid Australian postcode (4 digits)</span>
          </label>
        </div>

        <div class="flex justify-between gap-3">
          <button type="button" class="btn btn-ghost back-button" data-prev="3">Back</button>
          <button type="submit" class="btn btn-primary">See Results</button>
        </div>
      </div>

      <!-- Results Screen -->
      <div class="question-screen hidden" id="results-screen">
        <div class="alert mb-6" id="results-alert">
          <div id="results-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-10 w-10" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div>
            <h3 class="font-bold text-lg">Assessment Result</h3>
            <div class="text-sm" id="results-message"></div>
          </div>
        </div>

        <div class="space-y-4">
          <a href="/contact" class="btn btn-primary btn-block gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
            </svg>
            Get in Touch
          </a>

          <button type="button" class="btn btn-ghost btn-block" id="restart-button">
            Start Over
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const startTime = Date.now();

    const form = document.getElementById('eligibility-checker-form');
    const progressBar = document.getElementById('checker-progress-bar') as HTMLProgressElement;
    const progressText = document.getElementById('progress-text');
    const screens = document.querySelectorAll('.question-screen');
    const resultsScreen = document.getElementById('results-screen');
    const resultsMessage = document.getElementById('results-message');
    const resultsAlert = document.getElementById('results-alert');
    const restartButton = document.getElementById('restart-button');
    const agePresetButtons = document.querySelectorAll('.age-preset-btn');
    const ageInput = document.getElementById('age') as HTMLInputElement;

    let currentScreen = 1;
    const totalScreens = screens.length - 1;

    const userResponses: {
      age: string | null;
      ndis_funding: string | null;
      disability: string | null;
      postcode: string | null;
    } = {
      age: null,
      ndis_funding: null,
      disability: null,
      postcode: null
    };

    // Age preset buttons
    agePresetButtons.forEach(button => {
      button.addEventListener('click', function(this: HTMLElement) {
        const age = this.getAttribute('data-age');
        if (ageInput && age) {
          ageInput.value = age;
        }
        agePresetButtons.forEach(btn => {
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-outline');
        });
        this.classList.remove('btn-outline');
        this.classList.add('btn-primary');
      });
    });

    // Load saved responses
    const savedResponses = localStorage.getItem('eligibilityCheckerResponses');
    if (savedResponses) {
      try {
        const parsedResponses = JSON.parse(savedResponses);
        Object.assign(userResponses, parsedResponses);

        if (userResponses.age) {
          const ageEl = document.getElementById('age') as HTMLInputElement;
          if (ageEl) ageEl.value = userResponses.age;

          agePresetButtons.forEach(btn => {
            const btnAge = btn.getAttribute('data-age');
            if (btnAge && userResponses.age && parseInt(btnAge) === parseInt(userResponses.age)) {
              btn.classList.remove('btn-outline');
              btn.classList.add('btn-primary');
            }
          });
        }

        if (userResponses.ndis_funding) {
          const radioEl = document.querySelector(`input[name="ndis_funding"][value="${userResponses.ndis_funding}"]`) as HTMLInputElement;
          if (radioEl) radioEl.checked = true;
        }

        if (userResponses.disability) {
          const radioEl = document.querySelector(`input[name="disability"][value="${userResponses.disability}"]`) as HTMLInputElement;
          if (radioEl) radioEl.checked = true;
        }

        if (userResponses.postcode) {
          const postcodeEl = document.getElementById('postcode') as HTMLInputElement;
          if (postcodeEl) postcodeEl.value = userResponses.postcode;
        }
      } catch (e) {
        console.error('Error loading saved responses:', e);
        localStorage.removeItem('eligibilityCheckerResponses');
      }
    }

    function updateProgress(screenIndex: number) {
      const progress = (screenIndex / totalScreens) * 100;
      if (progressBar) progressBar.value = progress;
      if (progressText) progressText.textContent = `Step ${screenIndex} of ${totalScreens}`;
    }

    function showScreen(screenIndex: number) {
      screens.forEach(screen => {
        if (screen) screen.classList.add('hidden');
      });
      const nextScreen = document.getElementById(`question-${screenIndex}`);
      if (nextScreen) nextScreen.classList.remove('hidden');
      currentScreen = screenIndex;
      updateProgress(screenIndex);
    }

    // Next buttons
    document.querySelectorAll('.next-button').forEach(button => {
      button.addEventListener('click', function(this: HTMLElement) {
        const currentQuestionScreen = document.getElementById(`question-${currentScreen}`);

        let valid = true;
        if (currentQuestionScreen) {
          const inputs = currentQuestionScreen.querySelectorAll('input[required]');
          inputs.forEach(input => {
            if (input instanceof HTMLInputElement) {
              if (input.type === 'radio') {
                const radioGroup = input.name;
                if (!currentQuestionScreen.querySelector(`input[name="${radioGroup}"]:checked`)) {
                  valid = false;
                }
              } else if (!input.value.trim()) {
                valid = false;
                input.classList.add('input-error');
              }
            }
          });
        }

        if (!valid) return;

        // Store responses
        if (currentScreen === 1) {
          const ageEl = document.getElementById('age');
          if (ageEl instanceof HTMLInputElement) {
            userResponses.age = ageEl.value;
          }
        } else if (currentScreen === 2) {
          const radioEl = document.querySelector('input[name="ndis_funding"]:checked');
          if (radioEl instanceof HTMLInputElement) {
            userResponses.ndis_funding = radioEl.value;
          }
        } else if (currentScreen === 3) {
          const radioEl = document.querySelector('input[name="disability"]:checked');
          if (radioEl instanceof HTMLInputElement) {
            userResponses.disability = radioEl.value;
          }
        }

        localStorage.setItem('eligibilityCheckerResponses', JSON.stringify(userResponses));

        const nextScreen = parseInt(this.getAttribute('data-next') || '0');
        showScreen(nextScreen);
      });
    });

    // Back buttons
    document.querySelectorAll('.back-button').forEach(button => {
      button.addEventListener('click', function(this: HTMLElement) {
        const prevScreen = parseInt(this.getAttribute('data-prev') || '0');
        showScreen(prevScreen);
      });
    });

    // Form submission
    if (form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();

        const postcodeEl = document.getElementById('postcode');
        if (postcodeEl instanceof HTMLInputElement) {
          userResponses.postcode = postcodeEl.value;
        }
        localStorage.setItem('eligibilityCheckerResponses', JSON.stringify(userResponses));

        const age = parseInt(userResponses.age || '0');
        const hasDisability = userResponses.disability === 'yes';
        let resultMessage = '';
        let alertClass = 'alert-info';

        if (age > 65) {
          resultMessage = 'The person may qualify for Aged Care services. Want to speak to someone about available options?';
          alertClass = 'alert-warning';
        } else if (age <= 65 && hasDisability) {
          resultMessage = "Based on your responses, the person may be eligible for NDIS support. Let's discuss their specific needs.";
          alertClass = 'alert-success';
        } else {
          resultMessage = "Let's help you figure out the next steps together. Our specialists can guide you through the options available.";
          alertClass = 'alert-info';
        }

        if (resultsMessage) resultsMessage.textContent = resultMessage;

        if (resultsAlert) {
          resultsAlert.classList.remove('alert-info', 'alert-success', 'alert-warning');
          resultsAlert.classList.add(alertClass);
        }

        screens.forEach(screen => {
          if (screen) screen.classList.add('hidden');
        });
        if (resultsScreen) resultsScreen.classList.remove('hidden');
        if (progressBar) progressBar.value = 100;
        if (progressText) progressText.textContent = 'Complete!';

        const completionTime = (Date.now() - startTime) / 1000;

        if (typeof (window as any).gtag === 'function') {
          (window as any).gtag('event', 'eligibility_complete', {
            'service_type': 'ndis',
            'completion_time': completionTime,
            'age_range': getAgeRange(age),
            'has_disability': hasDisability
          });
        }
      });
    }

    function getAgeRange(age: number): string {
      if (age < 18) return 'under_18';
      if (age < 30) return '18_29';
      if (age < 50) return '30_49';
      if (age < 65) return '50_64';
      return '65_plus';
    }

    // Restart
    if (restartButton) {
      restartButton.addEventListener('click', function() {
        showScreen(1);
        if (form instanceof HTMLFormElement) {
          form.reset();
        }
        agePresetButtons.forEach(btn => {
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-outline');
        });
      });
    }

    showScreen(1);

    // Remove error class on input
    document.querySelectorAll('input').forEach(input => {
      input.addEventListener('input', function() {
        if (this instanceof HTMLElement) {
          this.classList.remove('input-error');
        }
      });
    });
  });
</script>
